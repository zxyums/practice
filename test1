
import React, { useEffect, useMemo } from "react";
import {
  FormHelperText,
  InputAdornment,
  MenuItem,
  Select,
  Tooltip,
} from "@mui/material";
import lodash from "lodash";
import { useController, useFormContext } from "react-hook-form";
import CustomLabel from "./CustomLabel"; // Retained original import
import Info from "@mui/icons-material/Info"; // Retained original import
import ArrowDropDownIcon from "@mui/icons-material/ArrowDropDown"; // Corrected icon import
import styles from "../../shared/styles"; // Corrected styles import
import { FieldConfig } from "../../types/formTypes"; // Corrected FieldConfig import
import { FixedSizeList } from "react-window"; // For virtualization

type Props = {
  control: any;
  config: FieldConfig;
  onChange?: (event: React.ChangeEvent<{ value: unknown }>, value: string) => void; // Separate onChange
};

const CustomSelectField: React.FC<Props> = ({ control, config, onChange }) => {
  const { register, clearErrors } = useFormContext();
  const { fieldState, field } = useController({
    control,
    name: config.name,
    defaultValue: config.defaultValue || "",
    rules: {
      required: config.required
        ? `${config.label} is required`
        : false,
    },
  });

  const { error } = fieldState;

  useEffect(() => {
    if (field.value) {
      clearErrors(config.name);
    }
  }, [field.value, clearErrors, config.name]);

  const handleOnChange = (event: any) => {
    const selectedValue = event.target.value;
    if (onChange) {
      onChange(event, selectedValue); // Call separate onChange prop if provided
    } else if (config.onChange) {
      config.onChange(event, selectedValue); // Call config-provided onChange if defined
    }
    field.onChange(selectedValue); // Default behavior
  };

  const renderValue = (selected: string) => {
    if (!selected) {
      return <span style={styles.fieldEntryStyles}>Select</span>;
    }
    const selectedOption = config.options?.find(
      (option) => option.value === selected
    );
    return selectedOption?.label || selected;
  };

  const sortedOptions = useMemo(
    () => lodash.orderBy(config.options, ["value"], ["asc"]),
    [config.options]
  );

  const ITEM_HEIGHT = 40;
  const DROPDOWN_HEIGHT = 300;

  const renderRow = ({ index, style }: { index: number; style: React.CSSProperties }) => {
    const option = sortedOptions[index];
    if (!option) return null; // Safeguard against invalid indices
    return (
      <MenuItem
        key={option.key}
        value={option.value}
        style={style}
        onClick={() =>
          handleOnChange({
            target: { value: option.value },
          } as React.ChangeEvent<{ value: unknown }>)
        }
      >
        {option.label}
      </MenuItem>
    );
  };

  const VirtualizedList = React.forwardRef<HTMLDivElement, any>((props, ref) => (
    <FixedSizeList
      ref={ref}
      height={DROPDOWN_HEIGHT}
      width="100%"
      itemSize={ITEM_HEIGHT}
      itemCount={sortedOptions.length}
      {...props}
    >
      {renderRow}
    </FixedSizeList>
  ));

  const IconComponent = (props: any) => (
    <Tooltip title={config.toolTips || ""}>
      <ArrowDropDownIcon {...props} />
    </Tooltip>
  );

  return (
    <div className="flexing">
      <CustomLabel htmlFor={config.name} label={config.label} />
      <Select
        id={config.name}
        value={field.value || ""}
        {...register(config.name)}
        onChange={handleOnChange}
        displayEmpty
        renderValue={renderValue}
        IconComponent={IconComponent}
        inputProps={{
          "data-testid": "custom_select",
          "aria-controls": config.name,
          "aria-label": config.label,
        }}
        MenuProps={{
          PaperProps: {
            style: { maxHeight: DROPDOWN_HEIGHT },
          },
          MenuListProps: {
            component: VirtualizedList,
          },
        }}
        disabled={config.readOnly}
        error={!!error}
      >
        <MenuItem value="" disabled>
          <em style={styles.fieldEntryStyles}>Select</em>
        </MenuItem>
      </Select>
      <FormHelperText style={{ color: error ? "#B71C1C" : "#999" }}>
        {error?.message || config.helperText || ""}
      </FormHelperText>
    </div>
  );
};

export default CustomSelectField;